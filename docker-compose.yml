version: '3.8'

services:
  # The Backend API Service (Uses the new Dockerfile.backend name)
  api:
    build:
      context: ./push-notification-system-backend
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file: ./push-notification-system-backend/.env
    
    # --- Source Code and Dependency Isolation Fix ---
    volumes:
      # 1. Mount host source code temporarily for the copy operation
      - ./push-notification-system-backend:/tmp/source:ro 
      # 2. Permanent named volume for source code (target of copy)
      - api_source:/app       
      # 3. Permanent named volume for dependencies
      - nodemodules:/app/node_modules 
      - ~/.secrets/firebase/alcoupon-webapp-firebase-adminsdk.json:/etc/secrets/firebase/key.json:ro

    environment:
      # This is the path INSIDE the container that the Node.js app reads
      FIREBASE_SERVICE_ACCOUNT_PATH: /etc/secrets/firebase/key.json
      # - FIREBASE_SERVICE_ACCOUNT_PATH=/app/credentials/firebase-credentials.json
      
    # CRITICAL FIX: The initial copy operation is now part of the command.
    # It copies the source code from the temporary host mount to the permanent named volume (/app)
    # on the first run, then starts the API.
    command: sh -c "cp -r /tmp/source/. /app && npm start"
    # --- End Isolation Fix ---
    ports:
      - 4000:4000
    expose:
      - 4000
    networks:
      - push_notification
    depends_on:
      - mongo
  # Helper service to copy source code (Path remains correct)
  api_copy_source:
    image: busybox
    volumes:
      - ./push-notification-system-backend:/tmp/source:ro
      - api_source:/app
    
  # The Frontend Application Service (Uses the new standard Dockerfile name)
  frontend:
    build:
      context: ./push-notification-system-frontend
      dockerfile: Dockerfile
    restart: "no"
    image: push-frontend:latest
    ports:
      - 80:80
    expose:
      - "80"
    networks:
      - push_notification
    depends_on:
      - api
    

  # ... (mongo and nginx-proxy services remain unchanged) ...
  mongo:
    image: mongo:4.4
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    expose:
      - 27017
    networks:
      - push_notification
  
  nginx-proxy:
    image: nginx:stable-alpine
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./push-notification-system-frontend/build:/usr/share/nginx/html:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    ports:
      - "80:80"
      - "443:443"
    networks:
      - push_notification
    depends_on:
      - api
      - frontend

networks:
  push_notification:
    driver: bridge

volumes:
  nodemodules:
    driver: local
  api_source:
    driver: local
  mongo_data:
    driver: local



# name: push-notification

# services:
#   mongo:
#     image: mongo
#     ports:
#       - 27017:27017
#     volumes:
#       - mongo_data:/data/db
#     networks:
#       - push_notification

    
#   api:
#     build:
#       context: ./push-notification-system-backend
#       dockerfile: Dockerfile
#     restart: unless-stopped
#     env_file: ./push-notification-system-backend/.env
#     volumes:
#       # - /usr/src/app/node_modules
#       - ./push-notification-system-backend:/app
#       - nodemodules:/app/node_modules
#       # - /Users/jamil/Downloads/alcoupon-webapp-firebase-adminsdk.json:/app/credentials/firebase-credentials.json:ro
#       - ~/.secrets/firebase/alcoupon-webapp-firebase-adminsdk.json:/etc/secrets/firebase/key.json:ro
    
#     # 2. Environment Variable (Tells the app the file's path)
#     environment:
#       - NODE_ENV=production
#       # This is the path INSIDE the container that the Node.js app reads
#       - FIREBASE_SERVICE_ACCOUNT_PATH=/app/credentials/firebase-credentials.json
      # FIREBASE_SERVICE_ACCOUNT_PATH: /etc/secrets/firebase/key.json 
#       # NODE_ENV: production
#     expose:
#       - 4000
#     ports:
#       - 4000:4000
#     networks:
#       - push_notification
#     depends_on:
#       - mongo
#     # command: npm run dev

#   # frontend:
#   #   build:
#   #     context: ./push-notification-system-frontend
#   #     dockerfile: Dockerfile
#   #   restart: "no"
#   #   env_file: ./push-notification-system-frontend/.env
#   #   volumes:
#   #     - frontend_static_data:/app/build
#   #     - ./push-notification-system-frontend:/app
#   #     - /app/node_modules

#   #   ports:
#   #     - 3000:3000
#   #   depends_on:
#   #     - api
#   #   networks:
#   #     - push_notification
#     # command: npm start


#   # frontend:
#   #   build:
#   #     context: ./push-notification-system-frontend
#   #     dockerfile: Dockerfile
#   #   restart: "no"
#   #   env_file: ./push-notification-system-frontend/.env
#   #   # volumes:
#   #     # CRITICAL: Host mount for source code changes (Dev)
#   #     # - ./push-notification-system-frontend:/app 
#   #     # Named volume to ensure node_modules are preserved (Dev)
#   #     # - frontend_nodemodules:/app/node_modules # Using a named volume for consistency
#   #     # NOTE: The conflicting 'frontend_static_data:/app/build' volume was removed.
#   #   ports:
#   #     - 3000:3000
#   #   depends_on:
#   #     - api
#   #   networks:
#   #     - push_notification

#   frontend:
#     build:
#       context: ./push-notification-system-frontend
#       dockerfile: Dockerfile
#       args:
#         - API_URL=http://api:4000
#         - FRONTEND_URL=http://frontend:3000
#     restart: "no"
#     image: myapp/nginx:prod
#     # env_file: ./push-notification-system-frontend/.env
#     networks:
#       - push_notification
#     depends_on:
#       - api
    

 


#   # nginx:
#   #   image: alpine/null # Use a dummy image
#   #   ports: []          # Remove host port binding
#   #   command: ["tail", "-f", "/dev/null"] # Keep it running but inactive
#   #   restart: "no"

#   nginx:
#     image: nginx:stable-alpine
#     container_name: nginx
#     restart: unless-stopped
#     ports:
#         - "80:80"
#         - "443:443"
#     volumes:
#       # - frontend_static_data:/usr/share/nginx/html:ro
#       - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
#       - /etc/letsencrypt:/etc/letsencrypt:ro
#       - ./push-notification-system-frontend/build:/usr/share/nginx/html:ro
#     depends_on:
#       - frontend
#       - api
#     networks:
#       - push_notification

# volumes:

#   mongo_data:
#     driver: local
#   nodemodules:
#     driver: local
# networks:
#   push_notification:
#     driver: bridge



